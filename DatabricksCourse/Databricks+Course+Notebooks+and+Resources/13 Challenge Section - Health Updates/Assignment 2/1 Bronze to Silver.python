{"version":"NotebookV1","origId":3603969348519338,"name":"1 Bronze to Silver","language":"python","commands":[{"version":"CommandV1","origId":3603969348519339,"guid":"d9b41d87-2462-4883-944f-5fcfca36f015","subtype":"command","commandType":"auto","position":0.5,"command":"# Reading in the bronze csv file into a dataframe called health_data \nfrom pyspark.sql.types import IntegerType, StringType, DoubleType, StructField, StructType\n\nhealth_data_path = '/mnt/health-updates/bronze/health_status_updates.csv'\n\n\nhealth_data_schema = StructType([\n                    StructField(\"STATUS_UPDATE_ID\", IntegerType(), False),\n                    StructField(\"PATIENT_ID\", IntegerType(), False),\n                    StructField(\"DATE_PROVIDED\", StringType(), False),\n                    StructField(\"FEELING_TODAY\", StringType(), True),\n                    StructField(\"IMPACT\", StringType(), True),\n                    StructField(\"INJECTION_SITE_SYMPTOMS\", StringType(), True),\n                    StructField(\"HIGHEST_TEMP\", DoubleType(), True),\n                    StructField(\"FEVERISH_TODAY\", StringType(), True),\n                    StructField(\"GENERAL_SYMPTOMS\", StringType(), True),\n                    StructField(\"HEALTHCARE_VISIT\", StringType(), True)\n                    ]\n                    )","commandVersion":68,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":1667732783507,"submitTime":1667732783453,"finishTime":1667732783532,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"b12e0a77-efe7-463c-980e-ecaf32188cdf"},{"version":"CommandV1","origId":3603969348519340,"guid":"0811bfba-ccf3-45c5-8ce2-ada822e6372d","subtype":"command","commandType":"auto","position":1.0,"command":"health_data = spark.read.csv(path = health_data_path, header=True, schema=health_data_schema)","commandVersion":35,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[{"name":"health_data","typeStr":"pyspark.sql.dataframe.DataFrame","schema":{"fields":[{"metadata":{},"name":"STATUS_UPDATE_ID","nullable":true,"type":"integer"},{"metadata":{},"name":"PATIENT_ID","nullable":true,"type":"integer"},{"metadata":{},"name":"DATE_PROVIDED","nullable":true,"type":"string"},{"metadata":{},"name":"FEELING_TODAY","nullable":true,"type":"string"},{"metadata":{},"name":"IMPACT","nullable":true,"type":"string"},{"metadata":{},"name":"INJECTION_SITE_SYMPTOMS","nullable":true,"type":"string"},{"metadata":{},"name":"HIGHEST_TEMP","nullable":true,"type":"double"},{"metadata":{},"name":"FEVERISH_TODAY","nullable":true,"type":"string"},{"metadata":{},"name":"GENERAL_SYMPTOMS","nullable":true,"type":"string"},{"metadata":{},"name":"HEALTHCARE_VISIT","nullable":true,"type":"string"}],"type":"struct"},"tableIdentifier":null}],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":1667732794712,"submitTime":1667732794691,"finishTime":1667732794983,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"31310716-be4a-4573-8cd1-b0763dec62a1"},{"version":"CommandV1","origId":3603969348519341,"guid":"2020822d-8a6b-4f7d-bf7e-3045d35dd156","subtype":"command","commandType":"auto","position":2.0,"command":"health_data.display()","commandVersion":5,"state":"finished","results":{"type":"listResults","data":[{"type":"table","data":[[203470,1024,"09/16/2022","Good","Be unable to work","Swelling",103.0,"Yes","Nausea","Outpatient visit"],[202320,1147,"09/15/2022","Fair","Be unable to do normal activities","Itching",100.9,"Yes","Vomiting","Telehealth / virtual health"],[200100,1189,"09/15/2022","Fair","Be unable to work","Swelling",103.1,"Yes","Fatigue or tiredness","Outpatient visit"],[200110,1054,"09/15/2022","Fair","Be unable to do normal activities","Swelling",103.0,"Yes","Chills","Outpatient visit"],[200270,1161,"09/15/2022","Good","Be unable to get care from a healthcare professional","Pain",102.3,"Yes","Vomiting","Telehealth / virtual health"],[200390,1161,"09/15/2022","Good","Be unable to work","Pain",99.9,"Yes","Muscle or body aches","Telehealth / virtual health"],[200530,1067,"09/15/2022","Good","Be unable to work","Pain",103.0,"Yes","Headache","Outpatient visit"],[200540,1154,"09/15/2022","Good","Be unable to work","Pain",104.5,"Yes","Headache","Outpatient visit"],[200620,1154,"09/15/2022","Good","Be unable to work","Pain",103.2,"Yes","Vomiting","Outpatient visit"],[200730,1067,"09/15/2022","Good","Be unable to work","Pain",101.1,"Yes","Chills","Outpatient visit"],[200940,1076,"09/15/2022","Good","Be unable to get care from a healthcare professional","Swelling",104.8,"Yes","Diarrhea","Outpatient visit"],[201020,1077,"09/15/2022","Good","Be unable to do normal activities","Redness",102.6,"Yes","Diarrhea","Hospitalization"],[201060,1077,"09/15/2022","Good","Be unable to work","Redness",99.8,"No","Muscle or body aches","Hospitalization"],[201100,1077,"09/15/2022","Good","Be unable to work","Redness",101.3,"Yes","Headache","Hospitalization"],[201470,1149,"09/15/2022","Good","Be unable to work","Pain",102.2,"Yes","Fatigue or tiredness","Telehealth / virtual health"],[201600,1059,"09/15/2022","Good","Be unable to work","Redness",100.6,"Yes","Fatigue or tiredness","Emergency room visit"],[201700,1059,"09/15/2022","Good","Be unable to work","Redness",99.9,"No","Headache","Emergency room visit"],[201750,1100,"09/15/2022","Good","Be unable to work","Pain",100.2,"No","Fatigue or tiredness","Emergency room visit"],[201860,1080,"09/15/2022","Good","Be unable to do normal activities","Pain",102.9,"Yes","Nausea","Emergency room visit"],[205090,1052,"09/15/2022","Good","Be unable to get care from a healthcare professional","Swelling",99.2,"No","Muscle or body aches","Outpatient visit"],[205360,1186,"09/15/2022","Good","Be unable to work","Pain",99.3,"No","Joint pains","Telehealth / virtual health"],[205530,1089,"09/15/2022","Poor","Be unable to work","Pain",101.3,"Yes","Vomiting","Outpatient visit"],[205620,1004,"09/15/2022","Poor","Be unable to do normal activities","Pain",102.5,"Yes","Muscle or body aches","Outpatient visit"],[205660,1004,"09/15/2022","Poor","Be unable to get care from a healthcare professional","Pain",104.8,"Yes","Diarrhea","Outpatient visit"],[205730,1089,"09/15/2022","Poor","Be unable to get care from a healthcare professional","Pain",102.6,"Yes","Muscle or body aches","Outpatient visit"],[205810,1005,"09/15/2022","Good","Be unable to get care from a healthcare professional","Swelling",103.3,"Yes","Headache","Outpatient visit"],[205950,1005,"09/15/2022","Good","Be unable to do normal activities","Swelling",100.5,"Yes","Joint pains","Outpatient visit"],[205960,1177,"09/15/2022","Good","Be unable to work","Swelling",99.6,"No","Nausea","Outpatient visit"],[206090,1151,"09/15/2022","Good","Be unable to work","Redness",101.9,"Yes","Chills","Hospitalization"],[206190,1151,"09/15/2022","Good","Be unable to get care from a healthcare professional","Redness",102.6,"Yes","Chills","Hospitalization"],[202610,1129,"09/15/2022","Good","Be unable to work","Swelling",99.8,"No","Fatigue or tiredness","Outpatient visit"],[202760,1196,"09/15/2022","Good","Be unable to get care from a healthcare professional","Pain",102.5,"Yes","Headache","Telehealth / virtual health"],[203050,1103,"09/15/2022","Good","Be unable to do normal activities","Pain",104.7,"Yes","Nausea","Outpatient visit"],[203070,1103,"09/15/2022","Good","Be unable to get care from a healthcare professional","Pain",103.9,"Yes","Vomiting","Outpatient visit"],[203160,1160,"09/15/2022","Good","Be unable to do normal activities","Pain",101.1,"Yes","Fatigue or tiredness","Outpatient visit"],[203190,1103,"09/15/2022","Good","Be unable to do normal activities","Pain",99.5,"Yes","Rash near injection site","Outpatient visit"],[203380,1083,"09/15/2022","Good","Be unable to work","Swelling",100.7,"Yes","Nausea","Outpatient visit"],[203460,1083,"09/15/2022","Good","Be unable to get care from a healthcare professional","Swelling",99.0,"No","Chills","Outpatient visit"],[201990,1100,"09/14/2022","Good","Be unable to work","Pain",99.9,"No","Headache","Emergency room visit"]],"arguments":{},"addedWidgets":{},"removedWidgets":[],"schema":[{"name":"STATUS_UPDATE_ID","type":"\"integer\"","metadata":"{}"},{"name":"PATIENT_ID","type":"\"integer\"","metadata":"{}"},{"name":"DATE_PROVIDED","type":"\"string\"","metadata":"{}"},{"name":"FEELING_TODAY","type":"\"string\"","metadata":"{}"},{"name":"IMPACT","type":"\"string\"","metadata":"{}"},{"name":"INJECTION_SITE_SYMPTOMS","type":"\"string\"","metadata":"{}"},{"name":"HIGHEST_TEMP","type":"\"double\"","metadata":"{}"},{"name":"FEVERISH_TODAY","type":"\"string\"","metadata":"{}"},{"name":"GENERAL_SYMPTOMS","type":"\"string\"","metadata":"{}"},{"name":"HEALTHCARE_VISIT","type":"\"string\"","metadata":"{}"}],"overflow":false,"aggData":[],"aggSchema":[],"aggOverflow":false,"aggSeriesLimitReached":false,"aggError":"","aggType":"","plotOptions":null,"isJsonSchema":true,"dbfsResultPath":null,"datasetInfos":[],"columnCustomDisplayInfos":{},"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":1667732796054,"submitTime":1667732796036,"finishTime":1667732796207,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["table",39]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"cca97c2c-338a-42d4-9402-a73167336246"},{"version":"CommandV1","origId":3603969348519342,"guid":"de74fbf6-ad70-45c6-baf2-3228e7c0fb74","subtype":"command","commandType":"auto","position":3.0,"command":"# converting the data type of date_provided\nfrom pyspark.sql.functions import to_date\nhealth_data = health_data.select(\n                                'STATUS_UPDATE_ID',\n                                'PATIENT_ID',\n                                to_date(health_data['DATE_PROVIDED'],'MM/dd/yyyy').alias('DATE_PROVIDED'),\n                                'FEELING_TODAY',\n                                'IMPACT',\n                                'INJECTION_SITE_SYMPTOMS',\n                                'HIGHEST_TEMP',\n                                'FEVERISH_TODAY',\n                                'GENERAL_SYMPTOMS',\n                                'HEALTHCARE_VISIT'\n                            )","commandVersion":144,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[{"name":"health_data","typeStr":"pyspark.sql.dataframe.DataFrame","schema":{"fields":[{"metadata":{},"name":"STATUS_UPDATE_ID","nullable":true,"type":"integer"},{"metadata":{},"name":"PATIENT_ID","nullable":true,"type":"integer"},{"metadata":{},"name":"DATE_PROVIDED","nullable":true,"type":"date"},{"metadata":{},"name":"FEELING_TODAY","nullable":true,"type":"string"},{"metadata":{},"name":"IMPACT","nullable":true,"type":"string"},{"metadata":{},"name":"INJECTION_SITE_SYMPTOMS","nullable":true,"type":"string"},{"metadata":{},"name":"HIGHEST_TEMP","nullable":true,"type":"double"},{"metadata":{},"name":"FEVERISH_TODAY","nullable":true,"type":"string"},{"metadata":{},"name":"GENERAL_SYMPTOMS","nullable":true,"type":"string"},{"metadata":{},"name":"HEALTHCARE_VISIT","nullable":true,"type":"string"}],"type":"struct"},"tableIdentifier":null}],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":1667732811253,"submitTime":1667732811234,"finishTime":1667732811325,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"a415f2a8-903b-4c03-be18-97c562c12785"},{"version":"CommandV1","origId":3603969348519343,"guid":"4b4d25e8-7876-4333-8029-e464dfd1823d","subtype":"command","commandType":"auto","position":8.0,"command":"# upsert into health_data table\nfrom pyspark.sql.functions import current_timestamp\nfrom delta.tables import *\n\ndeltaTable = DeltaTable.forPath(spark, '/mnt/health-updates/silver/health_data')\n\ndeltaTable.alias('tgt') \\\n  .merge(\n    health_data.alias('src'),\n    'tgt.status_update_id = src.status_update_id'\n  ) \\\n  .whenMatchedUpdate(set =\n    {\n      \"status_update_id\": \"src.status_update_id\",\n      \"patient_id\": \"src.patient_id\",\n      \"date_provided\": \"src.date_provided\",\n      \"feeling_today\": \"src.feeling_today\",\n      \"impact\": \"src.impact\",\n      \"injection_site_symptoms\": \"src.injection_site_symptoms\",\n      \"highest_temp\": \"src.highest_temp\",\n      \"feverish_today\": \"src.feverish_today\",\n      \"general_symptoms\": \"src.general_symptoms\",\n      \"healthcare_visit\": \"src.healthcare_visit\",\n      \"updated_timestamp\": current_timestamp()\n    }\n  ) \\\n  .whenNotMatchedInsert(values =\n    {\n      \"status_update_id\": \"src.status_update_id\",\n      \"patient_id\": \"src.patient_id\",\n      \"date_provided\": \"src.date_provided\",\n      \"feeling_today\": \"src.feeling_today\",\n      \"impact\": \"src.impact\",\n      \"injection_site_symptoms\": \"src.injection_site_symptoms\",\n      \"highest_temp\": \"src.highest_temp\",\n      \"feverish_today\": \"src.feverish_today\",\n      \"general_symptoms\": \"src.general_symptoms\",\n      \"healthcare_visit\": \"src.healthcare_visit\",\n      \"updated_timestamp\": current_timestamp()\n    }\n  ) \\\n  .execute()","commandVersion":128,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":1667733179002,"submitTime":1667733178957,"finishTime":1667733182479,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[["html",27]],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"6c2a0596-abe0-445a-b1ab-720fe9319eb7"},{"version":"CommandV1","origId":3603969348519344,"guid":"1b9895ac-f752-409a-8073-77a5146fe4fe","subtype":"command","commandType":"auto","position":10.0,"command":"dbutils.notebook.exit(\"Silver Processing Complete\")","commandVersion":14,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":null,"subcommandOptions":null,"contentSha256Hex":null,"nuid":"7185c64c-f4a6-4608-b116-0842467569a8"}],"dashboards":[],"guid":"aa3823c9-d085-491e-859c-0570769f4f34","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":4,"mostRecentlyExecutedCommandWithImplicitDF":{"commandId":3825101150005251,"dataframes":["_sqldf"]}},"reposExportFormat":"SOURCE"}